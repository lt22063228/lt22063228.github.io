---
layout: post
title: "linux  2  内核整理二"
description: ""
category: os
tags: [os]
---
{% include JB/setup %}

#### 内核同步介绍

简单讲:线程持有锁,而锁保护共享数据
linux自身实现了几种不同的锁机制.各种锁的主要区别在于:一些锁会简单的忙等待;而另外一些锁会使当前线程睡眠直到锁可用.

###### 造成并发执行的原因

处理器的中断信号随时可能打断正常的执行流,新的执行流可能与被中断的执行流处于同一个临界区.
多处理器的芯片可能存在多个cpu同时在一个临界区的情况.

内核中造成并发的地方,可能有:

1. 中断:中断几乎可以在任何时刻异步发生,也就随时可能打断当前正在执行的代码.
2. 软中断和tasklet:内核能在任何时刻唤醒或调度软中断的tasklet,打断正在执行的代码
3. 内核抢占:因为内核允许被抢占,新的任务可能进入临界区
4. 对称多处理:多个处理器同时执行代码

#### 内核同步方法

###### 原子操作

原子操作指诸如*compare-and-set*或*test_and_set_bit*,这些指令保证当某个线程获取一个值之后,内存的相应位置被锁定,然后设置相应的值.

###### 自旋锁

自旋锁操作如下可实现:
{% highlight c %}
while(compare_and_set(0, mutex)) {
	;
}
{% endhighlight %}

这段代码负责获取互斥锁,第一个获取值为0的线程获得锁,其他得不到锁的线程会不断在循环中等待

在不可睡眠的代码中必须使用自旋锁来保护诗句,例如中断上下文,软中断和tasklet
读写自旋锁的特点是多个读进程可以重入,而写进程必须互斥的获取锁

###### 信号量

信号量是一种可睡眠的锁,睡眠特性使得:

- 信号量适合于锁被长时间持有的情况,因为争用信号量的进程会进入睡眠状态
- 只能在进程上下文中使用信号量
- 可以在持有信号量的时候去睡眠
- 持有信号量同时不能持有自旋锁,因为自旋锁不允许睡眠,而信号量允许

###### 顺序锁

写锁的获取与自旋锁相同,因此一个时刻只能有一个写锁被获取.如下
{% highlight c %}
write_seqlock(&mr_seq_lock)
/* 写锁被获取... */
write_sequnlock(&mr_seq_lock)
{% endhighlight %}

读锁的获取稍有不同,如下
{% highlight c %}
unsigned long seq;
do {
	seq = read_seqbegin(&mr_seq_lock);
}while(read_seqretry(&mr_seq_lock, seq));
{% endhighlight %}
当有写锁被持有的时候,操作被阻塞,当没有的时候,获取读锁.
在读锁被获取的时候,写锁可以被持有,这样导致数据被临时改变.读进程会去验证当前值是否和之前获取的一样.如果不一样,说明有写进程修改了数据,它会在循环中持续的获取读锁,重复操作
如此以来,写锁不会的获取不会受读锁的影响.这种顺序锁对写操作更有利.

###### 禁止抢占

同一个cpu,如果有更高优先级的任务要执行,当前任务可能被新任务夺取cpu,这就是内核抢占.
因为内核是SMP-safe的,因此多个处理器之间不用考虑(代码保证了同步).如果自旋锁被持有,内核就不能被抢占(smp-safe并不阻止中断的到来,自旋锁被持有时,中断还会到来,中断能够到来,就有执行别的任务的可能).
因此获取自旋锁后,preempt-count被+1,阻止内核抢占.

有时候不需要自旋锁,但仍然需要关闭内核抢占.比如,每个处理器上的数据,如果数据对于cpu是唯一的,那么就不需要锁保护.但是内核若可抢占,那么新调度任务可能访问同一变量.

为了阻止内核抢占,可以简单的增加preempt_count.

#### 定时器和时间管理

系统有一个定时器,一般产生信号的频率是100HZ,即每秒100次信号,每次信号都会产生一次时钟中断.
全局变量jiffies用来记录系统自启动以来产生的节拍的总数.它使用顺序锁保护.
所有与定时器有关的任务都通过时钟中断触发.所有的定时器都以链表的形式存放在一起.但是为了让内核寻找超时定时器而遍历整个链表是很不明智的,给链表进行排序也不现实.
为了提高搜索效率,内核将定时器按它们的超时时间划分为5组,当超时时间接近的时候,定时器随着组一起下移.

###### 短延迟
内核提供的100HZ的时钟定时器,使用时钟中断来计时的精度只能到达10ms,更精确的计时可以使用执行的指令数来计时.因为内核知道处理器每秒执行多少次指令,因此内核可以选择执行制定数目的空指令达到短定时的功能.(每秒处理百万条指令)